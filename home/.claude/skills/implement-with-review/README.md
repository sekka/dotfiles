# 実装レビューループスキル

## 概要

実装とレビューを自動的に交互実行し、品質を安定させるスキル。
松尾研究所の実践的なAIコーディング管理手法から着想を得て、「実装 subagent ↔ レビュー subagent」のループを自動化。

## 特徴

- **自動化されたループ**: 実装 → レビュー → 修正 → 再レビューを最大3回自動実行
- **品質の安定化**: 一貫したプロセスで品質を担保
- **プロセスの固定化**: 「コマンド + タスク指定だけ」で再現可能
- **厳密なレビュー**: セキュリティ、パフォーマンス、テストを包括的にチェック

## 使い方

### 基本的な使用法

```bash
/implement-with-review "タスク内容を記述"
```

### 例1: 新機能の実装

```bash
/implement-with-review "ユーザー認証機能を実装する。JWT + bcrypt を使用し、セキュリティを重視。"
```

### 例2: バグ修正

```bash
/implement-with-review "ログイン時にセッションが切れるバグを修正する。原因を特定し、テストを追加。"
```

### 例3: リファクタリング

```bash
/implement-with-review "UserService クラスをリファクタリングし、可読性と保守性を向上させる。"
```

## ワークフロー

```
1. タスク内容の確認
   ↓
2. 実装 subagent で実装
   - TDD の原則に従う
   - セキュリティを考慮
   - テストを先に書く
   ↓
3. レビュー subagent で自動レビュー
   - コード品質
   - セキュリティ
   - パフォーマンス
   - テスト
   - ドキュメント
   ↓
4. 問題があれば修正
   ↓
5. 再レビュー（最大3回ループ）
   ↓
6. 合格したら完了報告
```

## レビュー項目

### 1. コード品質（Weight: 30%）

- 可読性（変数名、関数分割、ネスト）
- 保守性（DRY原則、SOLID原則）
- コーディング規約への準拠

### 2. セキュリティ（Weight: 35%）

- OWASP Top 10 への対応
- インジェクション攻撃への対策
- 認証・認可の適切な実装
- 機密情報の保護

### 3. パフォーマンス（Weight: 15%）

- N+1クエリ問題
- 不要な再レンダリング
- メモリリーク
- バンドルサイズ

### 4. テスト（Weight: 15%）

- TDD の実践
- カバレッジ（80%以上）
- エッジケースのテスト
- 実環境での動作確認

### 5. ドキュメント（Weight: 5%）

- README の更新
- CLAUDE.md の更新
- API ドキュメントの更新

## 問題の重要度

### Critical（致命的）

- セキュリティ脆弱性
- データ損失の可能性
- システムダウンの可能性

**対応:** 必ず修正。修正されるまで承認しない。

### Major（重大）

- 機能的な問題
- パフォーマンスの大幅な劣化
- 保守性の著しい低下

**対応:** 原則修正。特別な理由がない限り承認しない。

### Minor（軽微）

- コーディング規約違反
- 軽微な最適化の余地
- ドキュメントの不足

**対応:** 修正を推奨。状況に応じて承認可能。

## 成功基準

以下の条件を全て満たすことを成功とする:

1. レビューで Critical/Major 問題がない
2. テストが全て通過
3. セキュリティチェックに合格
4. ドキュメントが更新されている
5. コーディング規約に準拠

## ループの仕組み

### 最大ループ回数: 3回

- 1回目: 初回実装 → レビュー → 問題発見
- 2回目: 修正 → 再レビュー → 問題残存
- 3回目: 再修正 → 最終レビュー → 判定

### ループ終了条件

**合格パターン:**
- Critical/Major 問題がゼロ
- テスト全て通過

**警告付き合格パターン:**
- Minor 問題のみ残存
- 3回目のループで妥協

**不合格パターン:**
- 3回ループしても Critical 問題が残存
- ユーザーに判断を委ねる

## 出力例

```markdown
# 実装レビューループ完了

## 実装内容

- 変更ファイル:
  - src/auth/login.ts
  - src/auth/jwt.ts
  - tests/auth/login.test.ts
- ループ回数: 2回

## レビュー結果

- ステータス: ✅ 承認
- Critical: 0件
- Major: 0件
- Minor: 1件（console.log 残存 → 削除済み）

## 主要な変更

1. ユーザー認証機能の実装
   - JWT + bcrypt による安全な認証
   - プリペアドステートメントでSQLインジェクション対策
   - レート制限の実装

2. テストの追加
   - 正常系・異常系のテスト
   - SQLインジェクション対策のテスト
   - カバレッジ: 92%

## テスト結果

✅ All tests passed (12/12)

## 次のステップ

- [ ] 実環境での動作確認
- [ ] ドキュメントの最終確認
- [ ] コミット作成
```

## カスタマイズ

### 最大ループ回数の変更

`prompt.md` の `MAX_LOOPS` を変更:

```typescript
const MAX_LOOPS = 5; // デフォルト: 3
```

### レビュー基準の調整

`subagents/reviewer.md` のWeight（重み付け）を調整:

```markdown
### 1. コード品質（Weight: 30%）
### 2. セキュリティ（Weight: 35%）
### 3. パフォーマンス（Weight: 15%）
### 4. テスト（Weight: 15%）
### 5. ドキュメント（Weight: 5%）
```

## トラブルシューティング

### Q1: 何度もリジェクトされる

**A:** レビュー基準が厳しすぎる可能性があります。`reviewer.md` の基準を緩和するか、`AskUserQuestion` でユーザーに判断を仰いでください。

### Q2: ループが早く終わりすぎる

**A:** レビューが甘い可能性があります。`reviewer.md` のチェック項目を見直してください。

### Q3: 実装が要件と異なる

**A:** 実装前の要件確認が不十分です。`AskUserQuestion` で詳細をヒアリングしてください。

## 制約事項

- 最大ループ回数: 3回
- 各ループで必ずテストを実行
- 実環境での動作確認はユーザーが行う
- Critical 問題が残る場合はループを継続
- Minor 問題のみの場合は最終ループで合格とする

## 参考資料

- [松尾研究所の実践的なAIコーディング管理手法](https://zenn.dev/mkj/articles/868e0723efa060)
- TDD ワークフロー: `~/.claude/rules/tdd-workflow.md`
- コードレビューワークフロー: `~/.claude/rules/code-review-workflow.md`
- セキュリティ原則: `~/.claude/rules/security.md`

## ライセンス

MIT License

## バージョン履歴

- v1.0.0 (2026-01-31): 初版リリース
