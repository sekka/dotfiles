---
description: 指定したコードのリファクタリング
argument-hint: [対象ファイルまたは関数]
---

# リファクタリング

対象: $ARGUMENTS

## 実行内容

### Step 1: 現状分析

対象コードを読み込み、以下を確認：

- コードの責務と目的
- 依存関係（import/export）
- テストの有無とカバレッジ
- 呼び出し元の特定

### Step 2: 問題点の特定

以下の観点で問題を洗い出し：

#### コード品質

- [ ] 関数/メソッドが長すぎないか（目安: 50 行以内）
- [ ] 責務が単一か（Single Responsibility）
- [ ] 重複コードがないか（DRY）
- [ ] ネストが深すぎないか（目安: 3 段階以内）
- [ ] 命名が適切か
- [ ] マジックナンバー/マジックストリングがないか
- [ ] アンチパターンが使われていないか（スパゲッティコード、God Object等）

#### 設計

- [ ] 適切な抽象化レベルか
- [ ] インターフェースが明確か
- [ ] 依存関係の方向が適切か
- [ ] テスタビリティが確保されているか

#### パフォーマンス

- [ ] 不要な再計算がないか
- [ ] メモ化が必要な箇所はないか
- [ ] N+1 問題がないか

### Step 3: リファクタリング計画

改善案を以下の形式で提示：

```markdown
## リファクタリング計画

### 改善対象と優先度

| #   | 問題点 | 改善案 | リスク   | 影響範囲 | 優先度 |
| --- | ------ | ------ | -------- | -------- | ------ |
| 1   | ...    | ...    | 低/中/高 | ...      | 高/中/低 |

### 実施ステップとロールバック方針

1. **ステップ1**: [改善内容]
   - 実施方法: ...
   - 検証方法: ...
   - ロールバック方法: ...

2. **ステップ2**: [改善内容]
   - 実施方法: ...
   - 検証方法: ...
   - ロールバック方法: ...

### 追加すべきテスト

- [ ] [テストケース1]: [目的]
- [ ] [テストケース2]: [目的]

### 計測ポイント

- パフォーマンス: [計測すべきメトリクス]
- エラー率: [監視すべき箇所]
- 使用状況: [追跡すべきAPI/関数]

### API変更と互換性

**破壊的変更がある場合：**
- 廃止予定APIのマーク（deprecation warning）
- 移行期間の設定
- 移行ガイドの作成
- バージョン管理の方針
```

### Step 4: 実装（承認後）

以下の原則に従ってリファクタリング：

1. **小さなステップで進める**: 一度に大きな変更をしない
2. **テストを先に確認**: 既存テストがパスすることを確認
3. **振る舞いを変えない**: 外部から見た動作は同じに保つ
4. **頻繁にテスト実行**: 各ステップでテストを実行

### Step 5: 検証

- テストが全てパスすることを確認
- 型エラーがないことを確認
- lint エラーがないことを確認
- 必要に応じて新しいテストを追加

## リファクタリングパターン

### 抽出系

- **関数の抽出**: 長い関数を小さな関数に分割
- **変数の抽出**: 複雑な式に名前を付ける
- **クラスの抽出**: 責務を分離
- **インターフェースの抽出**: 共通の振る舞いを定義

### 移動系

- **関数の移動**: 適切なモジュール/クラスへ
- **フィールドの移動**: 適切なクラスへ
- **ステートメントの移動**: 関連するコードを近くに

### 整理系

- **条件分岐の整理**: Guard Clause、ポリモーフィズム
- **ループの分離**: 1 ループ 1 責務
- **一時変数の削除**: クエリに置き換え

### 名前変更系

- **変数名の変更**: 意図が伝わる名前に
- **関数名の変更**: 何をするか明確に
- **パラメータの追加/削除**

## リファクタリングのベストプラクティス

1. **影響範囲とリスクを明確にする**
   - 変更が及ぶファイルとモジュールを特定
   - 破壊的変更の可能性を評価
   - ロールバック手順を事前に準備

2. **小さく安全に進める**
   - 一度に1つのパターンだけを適用
   - 各ステップで動作を確認
   - コミットを細かく分ける

3. **テストカバレッジを確保する**
   - リファクタリング前に既存の振る舞いをテストでカバー
   - テストがない場合は先にテストを追加（characterization tests）
   - リファクタリング後に新しいテストを追加

4. **パフォーマンスへの影響を考慮する**
   - ホットパスのリファクタリングは慎重に
   - ベンチマークで性能低下がないことを確認
   - 必要に応じてプロファイリング

5. **セキュリティへの影響を評価する**
   - 認証/認可ロジックの変更は特に注意
   - 入力バリデーションの変更を確認
   - セキュリティレビューを実施

6. **API変更時の互換性を保つ**
   - 既存のAPIは deprecation warning で段階的に廃止
   - 新旧両方のAPIを一時的にサポート
   - 移行ガイドとサンプルコードを提供

## 注意事項

- リファクタリング前にテストがあることを確認
- テストがない場合は先にテストを追加
- 大規模な変更は複数の PR に分割を検討
- 振る舞いの変更が必要な場合は別タスクとして扱う
- 技術的負債が蓄積しているコードは、段階的に改善する計画を立てる
- モノリスの分割やモジュール化は、慎重な計画と段階的な実施が必要
