---
description: 指定したコードのリファクタリング
argument-hint: [対象ファイルまたは関数]
---

# リファクタリング

対象: $ARGUMENTS

## 実行内容

### Step 1: 現状分析

対象コードを読み込み、以下を確認：

- コードの責務と目的
- 依存関係（import/export）
- テストの有無とカバレッジ
- 呼び出し元の特定

### Step 2: 問題点の特定

以下の観点で問題を洗い出し：

#### コード品質

- [ ] 関数/メソッドが長すぎないか（目安: 50 行以内）
- [ ] 責務が単一か（Single Responsibility）
- [ ] 重複コードがないか（DRY）
- [ ] ネストが深すぎないか（目安: 3 段階以内）
- [ ] 命名が適切か
- [ ] マジックナンバー/マジックストリングがないか

#### 設計

- [ ] 適切な抽象化レベルか
- [ ] インターフェースが明確か
- [ ] 依存関係の方向が適切か
- [ ] テスタビリティが確保されているか

#### パフォーマンス

- [ ] 不要な再計算がないか
- [ ] メモ化が必要な箇所はないか
- [ ] N+1 問題がないか

### Step 3: リファクタリング計画

改善案を以下の形式で提示：

```markdown
| #   | 問題点 | 改善案 | リスク   | 影響範囲 |
| --- | ------ | ------ | -------- | -------- |
| 1   | ...    | ...    | 低/中/高 | ...      |
```

### Step 4: 実装（承認後）

以下の原則に従ってリファクタリング：

1. **小さなステップで進める**: 一度に大きな変更をしない
2. **テストを先に確認**: 既存テストがパスすることを確認
3. **振る舞いを変えない**: 外部から見た動作は同じに保つ
4. **頻繁にテスト実行**: 各ステップでテストを実行

### Step 5: 検証

- テストが全てパスすることを確認
- 型エラーがないことを確認
- lint エラーがないことを確認
- 必要に応じて新しいテストを追加

## リファクタリングパターン

### 抽出系

- **関数の抽出**: 長い関数を小さな関数に分割
- **変数の抽出**: 複雑な式に名前を付ける
- **クラスの抽出**: 責務を分離
- **インターフェースの抽出**: 共通の振る舞いを定義

### 移動系

- **関数の移動**: 適切なモジュール/クラスへ
- **フィールドの移動**: 適切なクラスへ
- **ステートメントの移動**: 関連するコードを近くに

### 整理系

- **条件分岐の整理**: Guard Clause、ポリモーフィズム
- **ループの分離**: 1 ループ 1 責務
- **一時変数の削除**: クエリに置き換え

### 名前変更系

- **変数名の変更**: 意図が伝わる名前に
- **関数名の変更**: 何をするか明確に
- **パラメータの追加/削除**

## 注意事項

- リファクタリング前にテストがあることを確認
- テストがない場合は先にテストを追加
- 大規模な変更は複数の PR に分割を検討
- 振る舞いの変更が必要な場合は別タスクとして扱う
