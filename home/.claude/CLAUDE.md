# Claude Code 行動指針

## 制約

- ユーザーの明示的な指示なく git commit / push しない
- 曖昧な要件は AskUserQuestion で必ず確認してから作業開始

## テスト

- 実装前にテストを書く（TDD）
- ユニットテストだけでなく実環境での動作確認も必須
- テスト失敗は先送りせず即座に対応

## 外部ツールへの情報送信

- 機密情報（APIキー、環境変数、顧客データ、社内URL）を外部ツールに送信禁止
- 詳細: `@.claude/rules/security.md`

## 技術調査の優先順位

1. ローカルコードベース検索（Grep, Glob, serena, grepai）
2. 公式ドキュメント（Context7, Claude Code Guide）
3. Web検索（WebSearch, WebFetch）
4. ブラウザ自動化はユーザー許可なく起動しない

## ブラウザ自動化ツールの選択

### playwright-cli vs Playwright MCP

**playwright-cli を使用する状況（トークン効率重視）:**
- 大規模コードベースと並行してブラウザ操作を行う場合
- 単純なページ遷移・フォーム入力・スクリーンショット取得
- 高スループットの自動化タスク（複数ページの巡回等）
- コンテキストウィンドウを節約したい場合
- 実行コマンド: `mise exec -- playwright-cli <command>`

**Playwright MCP を使用する状況（リッチな対話重視）:**
- 探索的な自動化（ページ構造を調べながら操作）
- セルフヒーリングテスト（要素が見つからない場合に代替手段を探す）
- 長時間の自律ワークフロー（ブラウザセッションを維持）
- アクセシビリティツリーを活用した詳細な要素解析
- 使用ツール: `mcp__plugin_playwright_playwright__*`

### 判断基準

コンテキスト使用量が50%を超えている、または以下の条件に該当する場合は **playwright-cli を優先**:
- コードベース全体を読み込んでいる
- 複数ファイルの編集を並行実施
- テスト実行結果を分析中

それ以外で、ページ構造の詳細な解析が必要な場合は **Playwright MCP を優先**。

## スキル活用

- Web開発: `managing-frontend-knowledge` スキルのナレッジベースを参照
- コードレビュー: `/reviewing-with-claude`（軽量）, `/reviewing-parallel`（包括的）
- 設計相談: `/ask-peer`
- 技術選定: `/evaluating-tools`

## オーケストレーション戦略

### サブエージェント委譲の原則

メインエージェントは直接作業を実行せず、専門サブエージェントに委譲する。

#### 委譲ルーティング

**Research タスク → researcher サブエージェント**
- コードベース調査
- 技術ドキュメント検索
- API仕様の確認
- ベストプラクティスの調査

**Implementation タスク → implementer サブエージェント**
- コード作成・編集
- ファイル生成
- テスト実行
- ビルド操作

**Review タスク → reviewer サブエージェント**
- コードレビュー
- 品質チェック
- セキュリティ監査

#### 並列 vs 逐次実行

**並列起動条件（すべて満たす場合）:**
- タスク間にファイル重複がない
- 依存関係がない
- 独立したドメイン（Frontend/Backend/Database）

**逐次起動条件（いずれか該当）:**
- タスクに依存関係がある
- 同一ファイルを操作する
- スコープ確認が必要

#### サブエージェント起動の品質基準

高品質な起動には以下を含める:
1. 具体的なスコープ/問題
2. ファイル参照とパス
3. 関連するコンテキスト/背景
4. 明確な成功基準
5. 制約や依存関係

**悪い例:** "認証を修正"

**良い例:** "OAuth リダイレクトループを修正。ログイン成功後に /login ではなく /dashboard にリダイレクトされるべき。src/lib/auth.ts の認証ミドルウェアと src/pages/login.tsx のリダイレクトハンドラーを参照。成功基準: ログイン後にユーザーが /dashboard に到達する。"

### メインエージェントの責務と制約

**メインエージェントは以下のみを実行:**
- タスクの分解と優先順位付け
- 適切なサブエージェントへのルーティング (Task tool 使用)
- サブエージェント間の調整
- 進捗の統合と報告
- ユーザーへの質問 (AskUserQuestion 使用)

**メインエージェントは以下を実行しない:**
- Read, Glob, Grep などの情報収集 → researcher に委譲
- Write, Edit などの実装作業 → implementer に委譲
- コードレビューや品質チェック → reviewer に委譲
- Bash コマンドの実行 → implementer に委譲
- 直接的なファイル操作全般

**使用可能なツール:** Task, AskUserQuestion のみ

## 参考資料

- TDD: `@.claude/rules/tdd-workflow.md`
- セキュリティ: `@.claude/rules/security.md`
- サブエージェント定義: `@.claude/agents/`
