# 共通ルール

## 基本原則

- 英語で思考する
- 私との対話には日本語を使用する
- 私も参照するドキュメントは日本語で記述する
  - ツールのためのドキュメントで、英語で記述されている必要がある場合は英語で問題ない
  - その場合はコメントの記述が許されているならば日本語でコメントを記述する
- 私の指示なく、以下の作業を行わない
  - 次のタスクを開始
  - Git コミット
  - GitHub にプッシュ

## ファイル参照とコンテキスト管理

- `@ファイルパス` 記法でファイルをコンテキストに含める
- `@ディレクトリ/` でディレクトリ全体を参照
- CLAUDE.md でインポート機能を使用する場合は `@path/to/import` 記法を使用
- コード参照時は `ファイルパス:行番号` の形式で位置を明示する
- 未読のファイルについて変更を提案しない（必ず先に読む）

## セキュリティとプライバシールール

- 機密ファイルには絶対にアクセスしない
  - `.env`、`.env.*`
  - `secrets/` ディレクトリ
  - 認証情報を含むファイル
  - `~/.ssh` ディレクトリ
- API キーやトークンは環境変数で管理
- 機密情報を CLAUDE.md やコミットメッセージに含めない
- セキュリティの脆弱性（XSS、SQL インジェクション、コマンドインジェクション等）を導入しない
- 脆弱なコードを書いた場合は即座に修正

## ツール使用ルール

### 専用ツールの優先使用

以下の操作には必ず専用ツールを使用し、Bash コマンドは使わない:

- **ファイル読み取り**: Read ツール（`cat`/`head`/`tail` は使わない）
- **ファイル編集**: Edit ツール（`sed`/`awk` は使わない）
- **ファイル作成**: Write ツール（`echo >` やヒアドキュメントは使わない）
- **ファイル検索**: Glob ツール（`find`/`ls` は使わない）
- **コンテンツ検索**: Grep ツール（`grep`/`rg` コマンドは使わない）
- **コードベース探索**: Task ツール（Explore サブエージェント）を使用
- **ユーザーへの情報伝達**: 直接テキストで出力（`echo` は使わない）

### 環境ツール使用ルール

- ファイル、コード、シェル操作のすべてについて、必ず環境ツールのみを使用する（例外なし）
- `environment_run_cmd` ツールで git CLI をインストールしたり使用しない
  - すべての環境ツールが Git 操作を処理するため
  - 手動で `.git` を変更すると環境の整合性が損なわれる
- 作業内容を確認する方法として `container-use log <env_id>` と `container-use checkout <env_id>` の使用方法をユーザーに必ず伝える

### 並列実行の原則

- 独立した複数のツール呼び出しは必ず並列実行する
- 依存関係がある場合のみ順次実行する
- プレースホルダーや推測値でパラメータを埋めない

## 情報収集・調査ルール

- すべて公開情報に基づき、一次ソース（公式ドキュメント、GitHub 実装等）を優先する
- 推測は原則しない。必要な場合は推測であることを明記する
- 不明な情報は推測せず、不明であると明記する
- フレームワークの利用方法は現在のバージョン情報をもとに Context7 MCP で調べる
- 実装で技術的に詰まった場合は Gemini MCP か O3 MCP に英語で相談する
- コードベース探索が必要な場合は、Task ツール（Explore サブエージェント）を使用してコンテキストを削減

## タスク管理ルール

- 複数ステップや複雑なタスクは TodoWrite ツールで計画と進捗を管理
- タスクが完了したら即座に完了マーク（バッチ処理しない）
- 常に 1 つのタスクのみを in_progress 状態に保つ
- タスクを完全に完了できない場合（エラー、部分実装等）は completed にしない
- タスクの content は命令形、activeForm は現在進行形で記述
- 単純で 1 ステップのタスクには TodoWrite を使わない

## コード作成ルール

- 生成するコードは、コメントを多めに入れて解説する

### コード品質

- 関数は集中して小さく保つ
- 既存のパターンを正確に踏襲する
- 行の最大長は 100 文字まで
- Edit/Write の後は自動的にフォーマッターを実行
- テストは必ず実行して結果を確認
- lint エラーと型エラーは全て解決

### シンプルさの原則（過剰エンジニアリングの回避）

- 要求された変更のみを実装（追加機能、リファクタリング、改善は行わない）
- 変更していないコードにドキュメント、コメント、型注釈を追加しない
- 発生し得ないシナリオのエラーハンドリング、フォールバック、バリデーションを追加しない
- 1 回限りの操作のためのヘルパー、ユーティリティ、抽象化を作らない
- 仮想的な将来の要件のための設計をしない
- 3 行の類似コードは早すぎる抽象化より良い
- 未使用のコードは完全に削除（変数名変更、再エクスポート、コメント等で残さない）
- 後方互換性のハックを追加しない

## エラーハンドリング

- エラーが発生したら即座に報告
- エラーメッセージを完全に読んで根本原因を特定
- 推測でエラーを回避しない
- 不明な場合は必ずユーザーに質問
- Hook によってブロックされた場合、調整可能か判断し、不可能ならユーザーに Hook 設定の確認を依頼

## Git・GitHub ルール

### コミット管理

- コミットメッセージには `chore`、`fix`、`feat`、`docs` のいずれかのプレフィックスを使用する
- コミットメッセージには AI 署名を含めない
- コミットメッセージは日本語で何をなぜ変更したのか記載する
- 非常に小さい粒度で定期的にコミットする
- Push する前にローカルで lint、test、typecheck が成功することを確認する
- CI にエラーがある限り PR はマージしない

### ブランチ・PR 管理

- ブランチ名：`feat/issue-1`、`fix/issue-2` 等（プレフィックス + Issue 番号）
- PR タイトル：`fix: issue-1 開発環境のサーバーエラーを解決`
- PR コメント内で Issue を関連づけ、マージ時に Close されるよう記載する

## エージェントとコマンドの活用

### Subagents（サブエージェント）の使用

- 専門タスクは適切なサブエージェントに委譲
- 主要な組み込みサブエージェント:
  - **Explore**: コードベース探索（読み取り専用、高速）
  - **Plan**: 実装前の計画作成
  - **code-reviewer**: コード変更後の品質チェック
  - **test-writer-fixer**: テストの作成、実行、修正
- カスタムサブエージェントは `.claude/agents/` に作成可能

### Plan Mode（プランモード）

- 複雑な実装や複数の有効なアプローチがある場合は EnterPlanMode を使用
- コードベースを探索して実装計画を作成
- ユーザー承認後に実装開始
- 単純な 1 ファイルの修正や明確な指示がある場合は不要

### Slash Commands（スラッシュコマンド）

- `/commit`: 変更のコミット
- `/generate-test`: テストコード生成
- `/improve-html`: HTML/CSS 改善
- カスタムコマンドは `.claude/commands/` に作成可能
- コマンドは `$ARGUMENTS` や `$1`, `$2` で引数を受け取れる

## コスト最適化

- 探索には Task ツール（Explore サブエージェント）を使用してコンテキストを削減
- ファイル全体を読む前に get_symbols_overview で概要を確認（Serena MCP 使用時）
- 繰り返しのクエリは避け、必要な情報を一度に取得
- 簡単なタスクには Haiku モデルを使用
- CLAUDE.md は簡潔に保ち、古い情報は定期的に削除
- プロンプトキャッシュを活用するため、類似リクエストをまとめる

## プロジェクト構造とメモリ管理

### CLAUDE.md の階層（優先度順）

1. **Enterprise**: 組織全体の設定（最高優先度）
2. **Project**: `.claude/CLAUDE.md`（チーム共有、Git で管理）
3. **User**: `~/.claude/CLAUDE.md`（全プロジェクトに適用、このファイル）
4. **Local**: `./CLAUDE.local.md`（個人用、`.gitignore` に含める）

### メモリ管理のベストプラクティス

- CLAUDE.md は簡潔に保つ（不要な情報は削除）
- プロジェクト固有の情報は Project レベルに
- 個人的な設定や好みは User レベルまたは Local レベルに
- `/memory` コマンドでメモリファイルを編集
- 見出しと箇条書きで構造化

### 推奨プロジェクト構造

```text
project/
├── .claude/
│   ├── CLAUDE.md                 # プロジェクト共有メモリ
│   ├── settings.json             # チーム共有設定
│   ├── settings.local.json       # 個人設定（.gitignore）
│   ├── agents/                   # カスタムサブエージェント
│   └── commands/                 # カスタムスラッシュコマンド
├── CLAUDE.local.md               # 個人用メモリ（.gitignore）
└── .gitignore                    # .claude/settings.local.json を含める
```

## Playwright MCP 使用ルール

### 絶対的な禁止事項

#### 1. いかなる形式のコード実行も禁止

- Python、JavaScript、Bash 等でのブラウザ操作
- MCP ツールを調査するためのコード実行
- subprocess やコマンド実行によるアプローチ

#### 2. 利用可能なのは MCP ツールの直接呼び出しのみ

- `playwright:browser_navigate`
- `playwright:browser_screenshot`
- 他の Playwright MCP ツール

#### 3. エラー時は即座に報告

- 回避策を探さない
- 代替手段を実行しない
- エラーメッセージをそのまま伝える
